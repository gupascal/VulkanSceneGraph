name: SonarAnalysis
on:
  push:
  pull_request:
    branches:
      - master
env:
  VulkanSDKVersion: 1.2.131.2
jobs:
  linux-build:
    runs-on: ubuntu-latest
    env:
      VULKAN_SDK: $GITHUB_WORKSPACE/$VulkanSDKVersion/x86_64
#      InstallPath: "../vsg"
    steps:
    - uses: actions/checkout@v2
#    - name: Cache
#      id: cache
#      uses: actions/cache@v1.1.2
#      with:
#        path: ${{env.VULKAN_SDK}}
#        key: VulkanSdkExtractedLinux
    - name: Download & Extract Vulkan SDK
#      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        wget --no-cookies -O ../vulkansdk-linux-x86_64-${{env.VulkanSDKVersion}}.tar.gz https://sdk.lunarg.com/sdk/download/${{env.VulkanSDKVersion}}/linux/vulkansdk-linux-x86_64-${{env.VulkanSDKVersion}}.tar.gz?u=
        tar -zxvf ../vulkansdk-linux-x86_64-${{env.VulkanSDKVersion}}.tar.gz -C ./
    - name: Download Sonar
      run: |
        export SONAR_SCANNER_VERSION=4.2.0.1873
        export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
        curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip 
        unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
        export PATH=$SONAR_SCANNER_HOME/bin:$PATH
        echo "::add-path::$SONAR_SCANNER_HOME/bin"
        export SONAR_SCANNER_OPTS="-server"

        curl --create-dirs -sSLo $HOME/.sonar/build-wrapper-linux-x86.zip https://sonarcloud.io/static/cpp/build-wrapper-linux-x86.zip
        unzip -o $HOME/.sonar/build-wrapper-linux-x86.zip -d $HOME/.sonar/
        export PATH=$HOME/.sonar/build-wrapper-linux-x86:$PATH
        echo "::add-path::$HOME/.sonar/build-wrapper-linux-x86"
    - name: CMake
      run: |
        cmake -D Vulkan_INCLUDE_DIR="${{env.VULKAN_SDK}}/include" \
          -D Vulkan_LIBRARY="${{env.VULKAN_SDK}}/lib/libvulkan.so" \
          -D CMAKE_INSTALL_PREFIX="${{env.InstallPath}}" .
    - name: Make with Sonar analysis
      run: |
        build-wrapper-linux-x86-64 --out-dir bw-output make -j 2
        sonar-scanner \
          -Dsonar.organization=gupascal \
          -Dsonar.projectKey=gupascal_VulkanSceneGraph \
          -Dsonar.sources=. \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.cfamily.build-wrapper-output=bw-output
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#    - run: make install
#    - name: Publish artifact
#      uses: actions/upload-artifact@v1
#      with:
#        name: VsgLinux64
#        path: "${{env.InstallPath}}"
